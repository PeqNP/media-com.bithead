<div class="ui-window">
  <script type="text/javascript">
    function $(this.id)(view) {
      let bundleId;
      let project; // Loaded project
      let history;
      let historyLogged = false;

      // List of commands that have been executed
      let commandHistory = [];
      // The last index used in the search
      let commandHistoryIndex = null;

      /**
       * @param {string} bundleId - App bundle ID
       */
      function configure(_bundleId) {
        bundleId = _bundleId;
      }
      this.configure = configure;

      async function loadProject() {
        let resp = await os.network.get(`/boss-code/project/${bundleId}`);
        project = resp;

        // FIXME: Because this uses a `UIListBox`, only two levels of folders
        // are supported.
        let options = [];
        for (let i = 0; i < project.files.length; i++) {
          let file = project.files[i];
          let opt = {
            id: file.path,
            name: file.name,
            data: file,
            child: false
          }
          options.push(opt);

          if (!isEmpty(file.files)) {
            for (let j = 0; j < file.files.length; j++) {
              let child = file.files[j];
              let opt = {
                id: child.path,
                name: child.name,
                data: child,
                child: true
              }
              options.push(opt);
            }
          }
        }

        view.ui.select("project-files").ui.addNewOptions(options);
      }

      function initializeEditor() {
        let editorInput = view.ui.textarea("editor");
        let editor = CodeMirror.fromTextArea(editorInput, {
          mode: "javascript",
          tabSize: 4,
          indentWithTabs: false,
          electricChars: true,
          lineWrapping: false,
          lineNumbers: true,
          autofocus: true
        });
        editor.setSize(null, "100%");
      }

      function initializeHistory() {
        let ta = view.ui.textarea("history");
        let editor = CodeMirror.fromTextArea(ta, {
          readOnly: true,
          mode: "javascript",
          theme: "monokai",
          tabSize: 4,
          indentWithTabs: false,
          electricChars: true,
          lineWrapping: false,
          lineNumbers: false,
          scrollPastEnd: false
        });
        editor.setSize(null, "100%");
        return editor;
      }

      function initializeConsole() {
        history = initializeHistory();

        let ta = view.ui.textarea("command");
        let editor = CodeMirror.fromTextArea(ta, {
          mode: "javascript",
          theme: "monokai",
          tabSize: 4,
          indentWithTabs: false,
          electricChars: true,
          lineWrapping: false,
          lineNumbers: false,
          extraKeys: {
            "Enter": function (cm) {
              let cmd = cm.getValue();
              let exec = cmd;
              if (cmd.startsWith("po ")) {
                exec = cmd.replace("po ", "").trim();
              }

              let log;
              try {
                log = eval(exec);
              }
              catch (error) {
                log = error;
              }

              if (log === undefined) {
                log = cmd;
              }
              else {
                log = `${cmd}\nreturn: ${log}`;
              }
              addLogToHistory(log);

              cm.setValue("");

              // Add last command issued to history
              commandHistory.push(cmd);
              // Reset command history index so that the last command issued
              // will be the one that was just issued.
              commandHistoryIndex = null;

              return false; // Prevent default behavior
            },
            "Up": function (cm) {
              if (isEmpty(commandHistory) || commandHistoryIndex < 0) {
                return;
              }

              // Command history has not been invoked
              if (isEmpty(commandHistoryIndex)) {
                commandHistoryIndex = commandHistory.length - 1;
              }
              else {
                commandHistoryIndex -= 1;
                if (commandHistoryIndex < 0) {
                  commandHistoryIndex = 0;
                  return;
                }
              }

              let cmd = commandHistory[commandHistoryIndex];
              cm.setValue(cmd);
            },
            "Down": function (cm) {
              if (isEmpty(commandHistory) || commandHistoryIndex >= commandHistory.length) {
                return;
              }

              // History has not been searched yet. Nothing to do.
              if (isEmpty(commandHistoryIndex)) {
                return;
              }

              commandHistoryIndex += 1;
              // Past fence, reset
              if (commandHistoryIndex > commandHistory.length - 1) {
                commandHistoryIndex = commandHistory.length - 1;
                return;
              }

              let cmd = commandHistory[commandHistoryIndex];
              cm.setValue(cmd);
            }
          },
          gutters: ["cm-console-gutter"]
        });
        editor.setSize(null, "100%");

        editor.setOption("gutter", function (view, line) {
          return '>';
        });
      }

      function addLogToHistory(log) {
        // NOTE: It's not enough to check the `history.lastLine()`. This method
        // can be called in quick succession, preventing the `lastLine()` from
        // updating. To avoid this, the `historyLogged` bool prevents the 2nd
        // line from not adding newline, if necessary.
        if (historyLogged) {
          log = `\n${log}`;
        }

        historyLogged = true;

        // Add command, and result, to history
        history.replaceRange(log, CodeMirror.Pos(history.lastLine()));
        history.scrollIntoView({line: history.lastLine(), ch: 0}, true);
      }

      function viewDidLoad() {
        if (isEmpty(bundleId)) {
          console.error("Editor must be configured via configure(bundleId:)");
          return;
        }

        Promise.all([
          os.network.stylesheet('$(app.resourcePath)/css/boss-code.css'),
          os.network.stylesheet('/codemirror/lib/codemirror.css'),
          os.network.javascript('/codemirror/lib/codemirror.js'),
          os.network.stylesheet('/codemirror/theme/monokai.css'),
        ])
          .then(([p1, p2]) => {
            os.network.javascript('/codemirror/mode/javascript/javascript.js')
              .then(async function() {
                await loadProject();
                initializeEditor();
                initializeConsole();
                view.ui.setTitle(project.name);
              });
          });

        let files = view.ui.select("project-files");
        files.ui.delegate = {
          didSelectListBoxOption: didSelectFile
        }
        let tabs = view.ui.select("file-tabs");
        tabs.ui.delegate = {
          didCloseTab: didCloseTab,
          didSelectTab: didSelectTab
        }

        os.patchSystemLogger(addLogToHistory);

        // TODO: Auto-save files if they are changed
      }
      this.viewDidLoad = viewDidLoad;

      function didSelectFile(option) {
        let tabs = view.ui.select("file-tabs").ui;
        let data = option.data;
        if (tabs.contains(data.path)) {
          tabs.selectTab(data.path); // Focus tab
          return;
        }

        // Only open json and html files
        if (!(data.name.endsWith(".json") || data.name.endsWith(".html"))) {
          return;
        }

        let idx = tabs.addTab({
          id: data.path,
          name: data.name,
          close: true
        });
        tabs.selectTab(data.path);
      }

      function didCloseTab(tab) {
        // TODO: Save file, if not saved
      }

      function didSelectTab(tab) {
        // TODO: Switch file being edited
        // TODO: If file associated to tab is not saved, load file from disk
        // TODO: Save previously selected tab's file, if any
      }

      function viewDidFocus() {
        // TODO: Wait for project to be loaded, then let app controller know(?)
        // OR, maybe the bundleId is good enough?
        $(app.controller).didFocusProject(bundleId);
      }
      this.viewDidFocus = viewDidFocus;
    }
  </script>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Untitled</span></div>
    <div class="zoom-button"></div>
  </div>
  <div class="container no-padding resizable group" style="width: 700px; height: 500px;">
    <div class="hbox" style="height: 100%">
      <div class="ui-list-box" style="width: 160px; height: 100%;">
        <select name="project-files"></select>
      </div>

      <div class="vbox" style="width: 100%;">
        <div class="ui-tabs">
          <select name="file-tabs"></select>
        </div> <!-- file-tabs -->

        <div style="flex-grow: 1;">
          <textarea name="editor"></textarea>
        </div> <!-- editor -->

        <div class="console">
          <div class="history"><textarea name="history"></textarea></div>
          <div class="command"><textarea name="command"></textarea></div>
        </div> <!-- console -->
      </div> <!-- vbox -->
    </div> <!-- hbox -->
  </div> <!-- container -->
</div>
